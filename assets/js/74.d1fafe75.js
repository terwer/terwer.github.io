(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{431:function(e,a,t){"use strict";t.r(a);var s=t(8),v=Object(s.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h3",{attrs:{id:"lease机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lease机制"}},[e._v("#")]),e._v(" Lease机制")]),e._v(" "),a("h4",{attrs:{id:"什么是lease机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是lease机制"}},[e._v("#")]),e._v(" 什么是Lease机制")]),e._v(" "),a("p",[e._v("Lease机制，就是租约机制，是一种在分布式协议中常用的协议，是维护分布式系统中数据一致性的常用工具。")]),e._v(" "),a("p",[e._v("Lease机制的特点：")]),e._v(" "),a("ul",[a("li",[e._v("Lease是颁发者对一段时间内数据一致性的承诺")]),e._v(" "),a("li",[e._v("颁发者发出Lease后，不管是否被接受，只要Lease不过期，颁发者都会按照协议，遵守承诺")]),e._v(" "),a("li",[e._v("Lease的持有者只能在Lease的有效期内使用承诺，一旦Lease超时，持有者需要放弃执行，重新申请Lease。")])]),e._v(" "),a("p",[e._v("以租车为例：")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220409144750794.png",alt:"image-20220409144750794"}})]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220409144832400.png",alt:"image-20220409144832400"}})]),e._v(" "),a("h4",{attrs:{id:"lease机制解决了什么问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lease机制解决了什么问题"}},[e._v("#")]),e._v(" Lease机制解决了什么问题")]),e._v(" "),a("p",[e._v("分布式系统中，如何确定一个节点是否正常工作？")]),e._v(" "),a("p",[e._v("假设有5个副本，1号是主副本。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220409145116580.png",alt:"image-20220409145116580"}})]),e._v(" "),a("p",[e._v("在分布式系统中最直观的办法是在主副本与副本之间维持一个心跳，期望通过心跳是否存在判断节点是否存活。")]),e._v(" "),a("p",[e._v("心跳其实无法从根本上解决分布式下节点是否正常这个问题，例如如下场景：")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("在某个时候几点Node1发生网络抖动或者网络中断情况（不是宕机），导致节点无法接收心跳")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410204553743.png",alt:"image-20220410204553743"}})])]),e._v(" "),a("li",[a("p",[e._v("会在剩下的节点中选区一个当做主节点")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410204709613.png",alt:"image-20220410204709613"}})])])]),e._v(" "),a("p",[e._v("主要解决思路有四种：")]),e._v(" "),a("ul",[a("li",[e._v("设计能够容忍双主的协议")]),e._v(" "),a("li",[e._v("Raft协议-通过term版本高的同步低的")]),e._v(" "),a("li",[e._v("用Lease机制")]),e._v(" "),a("li",[e._v("涉及去中心化-Gossip协议")])]),e._v(" "),a("h4",{attrs:{id:"lease的原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lease的原理"}},[e._v("#")]),e._v(" Lease的原理")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("引入中心节点负责下发Lease")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410210514165.png",alt:"image-20220410210514165"}})])]),e._v(" "),a("li",[a("p",[e._v("出现网络问题")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410210719374.png",alt:"image-20220410210719374"}})])])]),e._v(" "),a("p",[e._v("在1.05如果出现网络抖动，会导致其他节点申请Lease失败，因为节点在1.10之前都会承认有主节点，不允许其他节点再申请Lease。")]),e._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[a("p",[e._v("如果网络回复")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410211116169.png",alt:"image-20220410211116169"}})])]),e._v(" "),a("li",[a("p",[e._v("如果到了1.10，主节点会进行续约操作，然后下发新的Lease")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410211339197.png",alt:"image-20220410211339197"}})])]),e._v(" "),a("li",[a("p",[e._v("如果主节点宕机，其他节点申请Lease也会失败，承认主节点的存在")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410211536508.png",alt:"image-20220410211536508"}})])]),e._v(" "),a("li",[a("p",[e._v("当Lease过期时，副节点申请Lease成功")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/terwer/upload/img/image-20220410211853713.png",alt:"image-20220410211853713"}})])])]),e._v(" "),a("h4",{attrs:{id:"lease的容错"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lease的容错"}},[e._v("#")]),e._v(" Lease的容错")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("主节点宕机")]),e._v(" "),a("p",[e._v("Lease机制可容忍网络、接收方差错，时间就是Lease剩余的过期时长。")])]),e._v(" "),a("li",[a("p",[e._v("中心节点异常")]),e._v(" "),a("p",[e._v("颁发者宕机可能使得所有节点没有Lease，系统处于不可用状态。解决办法是使用一个小集群而不是单个节点来作为颁发者。")])]),e._v(" "),a("li",[a("p",[e._v("时差问题")]),e._v(" "),a("p",[e._v("中心节点与主节点之间的时差可能存在问题，只需要中心节点考虑时钟误差即可。")])])]),e._v(" "),a("p",[a("strong",[e._v("按照经验，Lease的时间差一般取1-10s即可。太短网络压力大，太长则，收回承诺时间过长，影响可用性。")])]),e._v(" "),a("h4",{attrs:{id:"应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用"}},[e._v("#")]),e._v(" 应用")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("GFS（Google 文件系统）中，Master通过Lease决定哪个是主副本，Lease在给各个节点的心跳响应中携带。")]),e._v(" "),a("p",[e._v("收不到心跳，则等待Lease过期，然后在颁发给其他节点。")])]),e._v(" "),a("li",[a("p",[e._v("chubby中，paxos选主后，从节点会给主办法lease，在期限内，不允许选择其他节点为主。")]),e._v(" "),a("p",[e._v("主节点给client发送lease，用于判断client是否存活。")])])])])}),[],!1,null,null,null);a.default=v.exports}}]);